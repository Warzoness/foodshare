"use client";

import { useState, useEffect, Suspense, useCallback } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import styles from "./Login.module.css";
import Link from "next/link";
import LoadingSpinner from "@/components/share/LoadingSpinner";
import { AuthService } from "@/services/site/auth.service";
import { SocialLoginRequest } from "@/types/auth";

// Declare global types for SDKs
declare global {
  interface Window {
    google: unknown;
    googleSDKLoaded: boolean;
  }
}

function LoginPageContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [sdkLoaded, setSdkLoaded] = useState(false);
  const [checkingAuth, setCheckingAuth] = useState(true);
  const [isMobile, setIsMobile] = useState(false);
  const [mounted, setMounted] = useState(false);

  // Ensure component is mounted before doing anything
  useEffect(() => {
    setMounted(true);
  }, []);

  // Check if user is already logged in
  useEffect(() => {
    if (!mounted) return;
    
    const checkExistingAuth = () => {
      try {
        const isLoggedIn = AuthService.isLoggedIn();
        if (isLoggedIn) {
          console.log('üîê User already logged in, redirecting to home');
          // Get returnUrl if available, otherwise go to home
          const returnUrl = searchParams.get('returnUrl') || searchParams.get('next') || '/';
          router.replace(returnUrl);
          return;
        }
        setCheckingAuth(false);
      } catch (error) {
        console.error('‚ùå Error checking existing auth:', error);
        setCheckingAuth(false);
      }
    };

    checkExistingAuth();
  }, [router, searchParams, mounted]);

  // Detect mobile device
  useEffect(() => {
    if (!mounted) return;
    
    const checkMobile = () => {
      const userAgent = navigator.userAgent || navigator.vendor || (window as any).opera;
      const isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
      const isSmallScreen = window.innerWidth <= 768;
      setIsMobile(isMobileDevice || isSmallScreen);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, [mounted]);

  // Load SDKs when component mounts
  useEffect(() => {
    if (!mounted) return;
    loadSDKs();
  }, [mounted]);

  const loadSDKs = async () => {
    try {
      console.log('üîÑ Loading Google SDK...');
      console.log('üìã Configuration:');
      console.log('  - Google Client ID:', process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID || '62641073672-3rjbtjt32kkng905ebr2nfebq3i18cl3.apps.googleusercontent.com');
      
      // Load Google SDK
      if (!window.google) {
        console.log('üîÑ Loading Google SDK...');
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://accounts.google.com/gsi/client';
          script.async = true;
          script.defer = true;
          script.onload = () => {
            window.googleSDKLoaded = true;
            console.log('‚úÖ Google SDK loaded successfully');
            console.log('üîç Google SDK object:', window.google);
            resolve(true);
          };
          script.onerror = (error) => {
            console.error('‚ùå Google SDK load error:', error);
            reject(error);
          };
          document.head.appendChild(script);
          console.log('üì§ Google SDK script added to DOM');
        });
      } else {
        console.log('‚úÖ Google SDK already loaded');
      }


      setSdkLoaded(true);
      console.log('‚úÖ All SDKs loaded successfully');
      console.log('üéØ Ready for authentication');
    } catch (error) {
      console.error('‚ùå Error loading SDKs:', error);
      setError('Kh√¥ng th·ªÉ t·∫£i SDK ƒëƒÉng nh·∫≠p');
    }
  };

  const renderGoogleButton = useCallback(() => {
    if (!sdkLoaded || !window.google || checkingAuth) {
      console.error('‚ùå Google SDK not loaded or component is redirecting:', { 
        sdkLoaded, 
        google: !!window.google, 
        checkingAuth 
      });
      return;
    }

    try {
      console.log('üîÑ Rendering Google Sign-In Button...');
      const clientId = process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID || '62641073672-3rjbtjt32kkng905ebr2nfebq3i18cl3.apps.googleusercontent.com';
      
      // Initialize Google Identity Services with mobile-optimized settings
      const googleConfig: any = {
        client_id: clientId,
        callback: (response: unknown) => {
          console.log('üìß Google callback triggered');
          console.log('üìß Google response received:', response);
          console.log('üìß Response type:', typeof response);
          console.log('üìß Response keys:', Object.keys(response || {}));
          
          if (response && typeof response === 'object' && response !== null && 'credential' in response) {
            console.log('‚úÖ Valid Google credential received');
            const credential = (response as { credential: string }).credential;
            console.log('üîç Credential length:', credential.length);
            console.log('üîç Credential preview:', credential.substring(0, 50) + '...');
            
            // Process the login
            processGoogleLogin(response);
          } else {
            console.error('‚ùå Invalid Google response:', response);
            setError('Ph·∫£n h·ªìi t·ª´ Google kh√¥ng h·ª£p l·ªá');
          }
        },
        auto_select: false,
        cancel_on_tap_outside: true,
        itp_support: true
      };

      // Configure for mobile vs desktop
      if (isMobile) {
        console.log('üì± Mobile device detected - using popup with fallback');
        // On mobile, still use popup but with better error handling
        googleConfig.ux_mode = 'popup';
        googleConfig.use_fedcm_for_prompt = false;
      } else {
        console.log('üñ•Ô∏è Desktop device detected - using popup flow');
        googleConfig.ux_mode = 'popup';
        googleConfig.use_fedcm_for_prompt = false;
      }

      (window.google as any).accounts.id.initialize(googleConfig);

      // Render Google Sign-In Button with mobile-optimized settings
      const buttonContainer = document.getElementById('google-login-button');
      if (buttonContainer && !checkingAuth) {
        const buttonConfig: any = {
          theme: 'outline',
          size: 'large',
          type: 'standard',
          shape: 'circle',
          text: 'signin_with',
          width: '250px',
          height: '50px'
        };

        // Configure button for mobile vs desktop
        if (isMobile) {
          console.log('üì± Rendering mobile-optimized Google button');
          buttonConfig.ux_mode = 'redirect';
          buttonConfig.use_fedcm_for_prompt = false;
        } else {
          console.log('üñ•Ô∏è Rendering desktop Google button');
          buttonConfig.ux_mode = 'popup';
          buttonConfig.use_fedcm_for_prompt = false;
        }

        (window.google as any).accounts.id.renderButton(buttonContainer, buttonConfig);
        console.log('‚úÖ Google Sign-In Button rendered');
      } else {
        console.error('‚ùå Google login button container not found or component is redirecting');
        if (!checkingAuth) {
          setError('Kh√¥ng th·ªÉ t·∫°o n√∫t ƒëƒÉng nh·∫≠p Google');
        }
      }
      
    } catch (error: unknown) {
      console.error('‚ùå Google button render error:', error);
      
      // Check if it's a popup blocking error
      const errorMessage = error instanceof Error ? error.message : String(error);
      if (errorMessage.includes('popup') || errorMessage.includes('blocked')) {
        if (isMobile) {
          setError('Tr√™n ƒëi·ªán tho·∫°i, vui l√≤ng cho ph√©p popup ho·∫∑c th·ª≠ ƒëƒÉng nh·∫≠p b·∫±ng tr√¨nh duy·ªát kh√°c.');
        } else {
          setError('Tr√¨nh duy·ªát ƒë√£ ch·∫∑n popup ƒëƒÉng nh·∫≠p. Vui l√≤ng cho ph√©p popup cho trang n√†y v√† th·ª≠ l·∫°i.');
        }
      } else if (errorMessage.includes('invalid') || errorMessage.includes('Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá')) {
        setError('C·∫•u h√¨nh Google OAuth kh√¥ng ƒë√∫ng. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
      } else {
        setError(errorMessage || 'Kh√¥ng th·ªÉ t·∫°o n√∫t ƒëƒÉng nh·∫≠p Google');
      }
    }
  }, [sdkLoaded, checkingAuth, isMobile]);

  // Auto-render Google button when SDK is loaded
  useEffect(() => {
    if (sdkLoaded && window.google && !checkingAuth) {
      console.log('üîÑ Auto-rendering Google Sign-In Button...');
      renderGoogleButton();
    }
  }, [sdkLoaded, checkingAuth, renderGoogleButton]);


  const processGoogleLogin = useCallback(async (credential: unknown) => {
    setLoading(true);
    setError(null);
    
    try {
      console.log('üì§ Processing Google credential...');
      console.log('üì§ Full credential object:', credential);
      
      const credentialData = credential as { credential: string };
      const loginRequest: SocialLoginRequest = {
        provider: 'GOOGLE',
        token: credentialData.credential
      };
      
      console.log('üì§ Sending login request to backend:', loginRequest);
      console.log('üì§ Request token length:', loginRequest.token.length);
      
      // Call AuthService
      console.log('üîÑ Calling AuthService.socialLogin...');
      const response = await AuthService.socialLogin(loginRequest);
      
      console.log('‚úÖ Login successful! Backend response:', response);
      
      // Redirect to intended page or home
      const returnUrl = searchParams.get('returnUrl') || searchParams.get('next') || '/';
      console.log('üîÑ Redirecting to:', returnUrl);
      router.replace(returnUrl);
      
    } catch (error: any) {
      console.error('‚ùå Google login processing error:', error);
      console.error('‚ùå Error type:', typeof error);
      console.error('‚ùå Error message:', error.message);
      console.error('‚ùå Error stack:', error.stack);
      
      // Provide user-friendly error messages
      let userMessage = 'X·ª≠ l√Ω ƒëƒÉng nh·∫≠p Google th·∫•t b·∫°i';
      
      if (error.message.includes('Invalid Google token')) {
        userMessage = 'Token Google kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.';
      } else if (error.message.includes('Failed to decode JWT')) {
        userMessage = 'L·ªói x·ª≠ l√Ω th√¥ng tin t·ª´ Google. Vui l√≤ng th·ª≠ l·∫°i.';
      } else if (error.message.includes('expired')) {
        userMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
      } else if (error.message.includes('popup')) {
        userMessage = 'Popup ƒëƒÉng nh·∫≠p b·ªã ch·∫∑n. Vui l√≤ng cho ph√©p popup ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c.';
      } else if (error.message.includes('network') || error.message.includes('fetch')) {
        userMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra internet v√† th·ª≠ l·∫°i.';
      }
      
      setError(userMessage);
    } finally {
      console.log('üèÅ Google login process finished');
      setLoading(false);
    }
  }, [searchParams, router]);


  // Show loading screen while checking authentication
  if (checkingAuth) {
    return (
      <div className={styles.screen}>
        <div className={styles.brandWrap}>
          <span className={styles.brand}>FoodShare</span>
        </div>
        <div className={styles.loginCard}>
          <LoadingSpinner 
            message="ƒêang ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p..." 
            size="small"
            className={styles.loadingSDK}
          />
        </div>
        <div className={styles.frame} />
      </div>
    );
  }

  return (
    <div className={styles.screen} suppressHydrationWarning={true}>
      <div className={styles.brandWrap}>
        <span className={styles.brand}>FoodShare</span><br/>
        <span className={styles.description}>Chia ƒë·ªì ƒÉn, g·∫Øn k·∫øt c·ªông ƒë·ªìng</span>
      </div>

      <div className={styles.loginCard}>
              {/* Error message */}
              {error && (
                <div className={styles.errorAlert} role="alert">
                  <div className="d-flex align-items-center">
                    <span className="me-2">‚ö†Ô∏è</span>
                    <span>{error}</span>
                  </div>
                   {error.includes('popup') && (
                     <div className="mt-2 p-2 bg-light rounded">
                       <strong>H∆∞·ªõng d·∫´n:</strong>
                       <ol className="mb-0 mt-1">
                         <li>Click v√†o bi·ªÉu t∆∞·ª£ng popup b·ªã ch·∫∑n tr√™n thanh ƒë·ªãa ch·ªâ</li>
                         <li>Ch·ªçn "Lu√¥n cho ph√©p popup t·ª´ trang n√†y"</li>
                         <li>Th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i</li>
                       </ol>
                     </div>
                   )}
                   {isMobile && (
                     <div className="mt-2 p-2 bg-info bg-opacity-10 rounded">
                       <strong>üì± H∆∞·ªõng d·∫´n cho ƒëi·ªán tho·∫°i:</strong>
                       <p className="mb-1">N·∫øu popup b·ªã ch·∫∑n, h√£y th·ª≠:</p>
                       <ol className="mb-1">
                         <li>Cho ph√©p popup cho trang n√†y</li>
                         <li>Th·ª≠ tr√¨nh duy·ªát kh√°c (Chrome, Safari)</li>
                         <li>ƒêƒÉng nh·∫≠p tr√™n m√°y t√≠nh tr∆∞·ªõc</li>
                       </ol>
                     </div>
                   )}
                  {error.includes('click') && (
                    <div className="mt-2 p-2 bg-info bg-opacity-10 rounded">
                      <strong>üí° G·ª£i √Ω:</strong>
                      <p className="mb-1">Vui l√≤ng click v√†o n√∫t <strong>&quot;ƒêƒÉng nh·∫≠p v·ªõi Google&quot;</strong> b√™n d∆∞·ªõi ƒë·ªÉ ƒëƒÉng nh·∫≠p.</p>
                    </div>
                  )}
                </div>
              )}

              {/* Social Login Buttons */}
              <div className={styles.socialButtons}>
                <h3 className={styles.sectionTitle}>ƒêƒÉng nh·∫≠p</h3>
                
                {!sdkLoaded && (
                  <div className={styles.loadingSDK}>
                    <LoadingSpinner 
                      size="small" 
                      message="ƒêang t·∫£i SDK ƒëƒÉng nh·∫≠p..." 
                      showMessage={true}
                    />
                  </div>
                )}
                
                {/* Google Sign-In Button Container */}
                <div id="google-login-button" className={styles.googleButtonContainer}>
                  {/*{loading && (*/}
                  {/*  <div className={styles.loadingOverlay}>*/}
                  {/*    <LoadingSpinner*/}
                  {/*      size="small"*/}
                  {/*      variant="white"*/}
                  {/*      message="ƒêang ƒëƒÉng nh·∫≠p..."*/}
                  {/*      showMessage={true}*/}
                  {/*    />*/}
                  {/*  </div>*/}
                  {/*)}*/}
                </div>
              </div>

              {/* Skip Button */}
              <div className={styles.skipSection}>
                <Link href="/" className={`${styles.skipBtn} btn btn-outline-light`}>
                  B·ªè qua ƒëƒÉng nh·∫≠p
                </Link>
              </div>

            </div>

      {/* Decorative corner frame (optional) */}
      <div className={styles.frame} />
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense fallback={<div>ƒêang t·∫£i...</div>}>
      <LoginPageContent />
    </Suspense>
  );
}